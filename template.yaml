AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Webex Learning Bot with Step Functions workflow.

Globals:
  Function:
    Runtime: nodejs18.x
    MemorySize: 128
    Timeout: 30

Resources:
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH

  RulesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: ruleId
          AttributeType: S
      KeySchema:
        - AttributeName: ruleId
          KeyType: HASH

  InputDataBucket:
    Type: AWS::S3::Bucket

  CheckAttendanceFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/functions/checkAttendance/index.handler
      CodeUri: ./
      Environment:
        Variables:
          AWS_REGION: !Ref AWS::Region
          USERS_TABLE_NAME: !Ref UsersTable
          RULES_TABLE_NAME: !Ref RulesTable
    
  ReminderHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/functions/reminderHandler/index.handler
      CodeUri: ./

  SendMessageFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/functions/sendMessage/index.handler
      CodeUri: ./
      Environment:
        Variables:
          AWS_REGION: !Ref AWS::Region
          WEBEX_BOT_TOKEN_SECRET_NAME: WebexBotToken
          WEBEX_MESSGING_API_URL: https://webexapis.com/v1/messages
          LOG_FILE_PATH: /tmp/messages.log
          USERS_TABLE_NAME: !Ref UsersTable
      Policies:
        - SecretsManagerReadWritePolicy:
            SecretName: WebexBotToken
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable

  IngestFromS3Function:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/functions/ingestFromS3/index.handler
      CodeUri: ./
      Environment:
        Variables:
          AWS_REGION: !Ref AWS::Region
          USERS_TABLE_NAME: !Ref UsersTable
          INPUT_BUCKET_NAME: !Ref InputDataBucket
          INPUT_OBJECT_KEY: input/users.json
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - S3ReadPolicy:
            BucketName: !Ref InputDataBucket
      Events:
        IngestSchedule:
          Type: Schedule
          Properties:
            Schedule: rate(1 day)
            Enabled: false

  SeedRulesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: src/functions/seedRules/index.handler
      CodeUri: ./
      Environment:
        Variables:
          AWS_REGION: !Ref AWS::Region
          RULES_TABLE_NAME: !Ref RulesTable
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref RulesTable

  LearningWorkflowStateMachine:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: EXPRESS
      DefinitionUri: src/stateMachine/learningWorkflow.asl.json
      DefinitionSubstitutions:
        CheckAttendanceFnArn: !GetAtt CheckAttendanceFunction.Arn
        ReminderHandlerFnArn: !GetAtt ReminderHandlerFunction.Arn
        SendMessageFnArn: !GetAtt SendMessageFunction.Arn
      Policies:
        - LambdaInvokePolicy:
            FunctionName: !Ref CheckAttendanceFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref ReminderHandlerFunction
        - LambdaInvokePolicy:
            FunctionName: !Ref SendMessageFunction

Outputs:
  UsersTableName:
    Description: Name of the Users DynamoDB Table
    Value: !Ref UsersTable
  RulesTableName:
    Description: Name of the Rules DynamoDB Table
    Value: !Ref RulesTable
  InputDataBucketName:
    Description: Name of the input S3 bucket
    Value: !Ref InputDataBucket
  SeedRulesFunctionArn:
    Description: ARN of the Seed Rules Lambda Function
    Value: !GetAtt SeedRulesFunction.Arn
  CheckAttendanceFunctionArn:
    Description: ARN of the CheckAttendance Lambda Function
    Value: !GetAtt CheckAttendanceFunction.Arn
  ReminderHandlerFunctionArn:
    Description: ARN of the ReminderHandler Lambda Function
    Value: !GetAtt ReminderHandlerFunction.Arn
  SendMessageFunctionArn:
    Description: ARN of the SendMessage Lambda Function
    Value: !GetAtt SendMessageFunction.Arn
  LearningWorkflowStateMachineArn:
    Description: ARN of the Learning Workflow State Machine
    Value: !GetAtt LearningWorkflowStateMachine.Arn
